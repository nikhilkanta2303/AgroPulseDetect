<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

  <nav>
    <h2>Namaste Farmer! üßë‚Äçüåæ</h2>
    <ul>
      <li><a href="index.html">Home</a></li>
      <li><a href="rscan.html">Real-Time Scan</a></li>
      <li><a href="#">About</a></li>
    </ul>
  </nav>

  <center>
    <div id="top"><h2 id="title"><span id="titlesplit">Agro</span>Pulse „ÄΩÔ∏è Detect</h2></div>
    <p style="font-size: 12px;color: rgb(184, 40, 40);">_upload plant/crop image by clicking "choose file"</p>
    <video id="cameraFeed" autoplay playsinline style="max-width: 100%; max-height: 70vh;"></video>
    <br>
    <div id="buttonsection">
      <button type="button" onclick="switchCamera()">Switch Camera</button>
      <button type="button" onclick="captureImage()">Capture</button>
      <button type="button" onclick="predict()">Predict</button>
      <button type="button" onclick="reload()">Clear</button>
    </div>
    <br>
    <div><p>Expected Disease for this plant</p></div>
    <div id="label-container"></div>
  </center>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

  <script type="text/javascript">
    let currentCamera = 'environment'; // 'environment' for back camera, 'user' for front camera
    const video = document.getElementById('cameraFeed');
    let videoStream;

    const switchCamera = async () => {
      currentCamera = (currentCamera === 'environment') ? 'user' : 'environment';
      await captureImage(); // Stop the current stream
      await startCamera(); // Start the new stream
    }

    const startCamera = async () => {
      try {
        const constraints = {
          video: {
            facingMode: currentCamera,
          },
        };
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = videoStream;
      } catch (error) {
        console.error('Error accessing camera:', error);
      }
    }

    const captureImage = async () => {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }
    }

    const reload = () => window.location.reload();

    const modelURL = "https://teachablemachine.withgoogle.com/models/_kFky0T01/";
    let model;

    const init = async () => {
      const modelJsonURL = `${modelURL}model.json`;
      const metadataURL = `${modelURL}metadata.json`;
      model = await tmImage.load(modelJsonURL, metadataURL);
      await startCamera();
    }

    const predict = async () => {
      const prediction = await model.predict(video);
      const labelContainer = document.getElementById("label-container");
      labelContainer.innerHTML = "";
      prediction.forEach(pred => {
        if (pred.probability.toFixed(2) > 0.5) { // Set your threshold here
          const classPrediction =
            `${pred.className}: ${pred.probability.toFixed(2)}`;
          const labelDiv = document.createElement("div");
          labelDiv.innerHTML = classPrediction;
          labelContainer.appendChild(labelDiv);
        }
      });
    }

    window.onload = init;
  </script>

</body>
</html>
